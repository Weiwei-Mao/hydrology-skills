name: Sync Upstream Scientific Skills

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´ 9:00 AM (UTC 1:00 AM) è¿è¡Œ
  schedule:
    - cron: '0 1 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: git remote add upstream https://github.com/anthropics/scientific-skills.git

      - name: Fetch upstream
        run: git fetch upstream

      - name: Get current upstream skills
        id: upstream_skills
        run: |
          # èŽ·å–ä¸Šæ¸¸æ‰€æœ‰æŠ€èƒ½ç›®å½•å
          SKILLS=$(git ls-tree -r --name-only upstream/main -- hydrology-skills/ 2>/dev/null | grep -E '^[^/]+/SKILL.md$' | sed 's|/SKILL.md||' | sort)
          echo "skills<<EOF" >> $GITHUB_OUTPUT
          echo "$SKILLS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for new skills
        id: check_new
        run: |
          # èŽ·å–å½“å‰å·²æœ‰çš„æŠ€èƒ½
          CURRENT_SKILLS=$(ls -1 hydrology-skills/ 2>/dev/null | sort)

          # æ‰¾å‡ºä¸Šæ¸¸æœ‰ä½†æœ¬åœ°æ²¡æœ‰çš„æ–°æŠ€èƒ½
          NEW_SKILLS=$(comm -13 <(echo "$CURRENT_SKILLS") <(echo "${{ steps.upstream_skills.outputs.skills }}"))

          if [ -n "$NEW_SKILLS" ]; then
            echo "new_skills<<EOF" >> $GITHUB_OUTPUT
            echo "$NEW_SKILLS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "Found new skills:"
            echo "$NEW_SKILLS"
          else
            echo "No new skills found"
            echo "new_skills=" >> $GITHUB_OUTPUT
          fi

      - name: Create sync branch
        if: steps.check_new.outputs.new_skills != ''
        run: git checkout -b sync/skills-${{ github.run_number }}

      - name: Copy new skills from upstream
        if: steps.check_new.outputs.new_skills != ''
        run: |
          for skill in ${{ steps.check_new.outputs.new_skills }}; do
            echo "Copying new skill: $skill"
            git checkout upstream/main -- "hydrology-skills/$skill"
          done

      - name: Generate sync report
        if: steps.check_new.outputs.new_skills != ''
        run: |
          cat > sync_report.md << 'REPORT'
          # Upstream Sync Report

          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Upstream:** anthropics/scientific-skills
          **Run:** #${{ github.run_number }}

          ## New Skills Added

          REPORT

          for skill in ${{ steps.check_new.outputs.new_skills }}; do
            echo "- \`$skill\`" >> sync_report.md
          done

          echo "" >> sync_report.md
          echo "## Next Steps" >> sync_report.md
          echo "" >> sync_report.md
          echo "1. Review each new skill and decide whether to keep it" >> sync_report.md
          echo "2. Update README.md to add relevant skills" >> sync_report.md
          echo "3. Remove skills that don't match hydrology research focus" >> sync_report.md
          echo "" >> sync_report.md
          echo "## Evaluation Criteria" >> sync_report.md
          echo "" >> sync_report.md
          echo "| Category | Keep | Skip |" >> sync_report.md
          echo "|----------|------|------|" >> sync_report.md
          echo "| Data | Hydrology, time series, geospatial | Bio/medical |" >> sync_report.md
          echo "| Modeling | Numerical, optimization, ML/DL | Molecular, quantum |" >> sync_report.md
          echo "| Writing | Academic, citations | Non-academic |" >> sync_report.md
          echo "| Cross-disciplinary | Economics, environment | Pure medical |" >> sync_report.md

          cat sync_report.md

      - name: Commit changes
        if: steps.check_new.outputs.new_skills != ''
        run: |
          git add hydrology-skills/
          git add sync_report.md
          git commit -m "chore: sync new skills from upstream

          - Added ${{ steps.check_new.outputs.new_skills }} new skill(s)
          - See sync_report.md for details

          ðŸ¤– Generated by [Claude Code](https://claude.com/claude-code)
          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

      - name: Push to origin
        if: steps.check_new.outputs.new_skills != ''
        run: git push origin sync/skills-${{ github.run_number }}

      - name: Create pull request
        if: steps.check_new.outputs.new_skills != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_BODY=$(cat sync_report.md)
          gh pr create \
            --title "chore: sync new skills from upstream (#${{ github.run_number }})" \
            --body "$PR_BODY" \
            --label "sync,automated" \
            --base master \
            --head sync/skills-${{ github.run_number }}

      - name: Summary
        if: steps.check_new.outputs.new_skills != ''
        run: |
          echo "### Sync completed :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**New skills found:** ${{ steps.check_new.outputs.new_skills }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A pull request has been created. Please review and merge." >> $GITHUB_STEP_SUMMARY
